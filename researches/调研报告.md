# 调研报告

> **灵活组合的操作系统模块和框架—[ArceOS](https://github.com/rcore-os/arceos)**

## 项目概述

基于组件化设计的思路，用Rust语言的丰富语言特征，设计实现不同功能的独立操作系统内核模块和操作系统框架，可形成不同特征/形态/架构的操作系统内核。让领域操作系统易于定制/开发/复用。

## 项目背景

- 新应用带来的操作系统新需求
  - 偏基础类的机器学习、机密计算，以及偏行业类的自动驾驶、工业机器人等新兴计算机领域，带来了各种不同的新应用需求。例如在智能汽车的控制领域，需要支持非常轻量实时高可靠的嵌入式应用；在智能汽车的智驾领域，需要支持AI加速和及时处理环境大数据的人工智能应用。这几类应用的需求更偏向于安全、可靠地及时响应事件和高效处理数据，对操作系统的功能要求和外设支持要求相对也少了不少。
    - 现有的Linux、Windows等传统通用操作系统不能充分地满足这些需求。对于这类应用，使用庞大的通用操作系统在功能上当然可以满足要求，但会带来性能、安全和可靠性等方面的不足；小型、专用的操作系统则更容易满足这方面的要求。
    - 现有的RTOS等专用系统不能充分地满足这些需求。现有的RTOS主要面向的是传统的嵌入式应用，所以在设计上很简洁，实时性是其考虑的重点。但现有的人工智能应用的复杂性很高，大量人工智能应用在Linux上开发和运行，难以直接运行在RTOS上。如果要运行在RTOS上，需要考虑对AI加速外设的支持，以及对Linux应用的支持，这对很多RTOS而言，有比较大的挑战。
  - 因此，这些领域的开发者希望研发面向特定领域的新型操作系统。然而，操作系统开发工作的复杂性让开发者望而却步。针对这种需求，我们希望让开发操作系统变得像开发应用一样简单和高效。
- **开发组件化的定制操作系统**
  - 开发组件化的定制操作系统是解决这个问题的方案之一。我们认为将来的操作系统不是像现在统治世界的 Linux、Windows 那样庞大而通用，而是各种可以迅速组合形成的，并且功能丰富多彩的组件化定制操作系统，能够快速适配未来多种多样的处理器、加速器、外设和应用需求，在开发的便捷性、性能和安全性等方面优于已有的通用操作系统。但如何设计组件化定制操作系统是一个需要深入思考的挑战性问题。
    - 实际上，传统的Linux、Windows、FreeBSD也采用了模块化/组件化的设计思路，而且支持内核模块的动态加载和卸载；但由于它们把通用性和性能放在第一位，而且采用C/C++编写，各个模块之间的数据访问和函数调用都以紧耦合的方式。这个特性使得这些操作系统的软件不具有重用性，很难被其他操作系统使用。这样，这些操作系统为了实现对各种应用的支持，变得越来越庞大和臃肿。
- **开发高鲁棒性、高性能的操作系统**
  - 由于我们需要开发的是一个通用模块化操作系统，系统内核的鲁棒性及性能必须得到保证。一个含有bug的低性能内核对这样一个系统是不可接受的。内核最好还能保证良好的实时性，以便定制为实时操作系统。

## 立项依据及前瞻性、重要性分析

- **[Rust](https://www.rust-lang.org/)：适合操作系统开发的新兴编程语言**
  - Rust 语言具有与 C 一样的硬件控制能力，且大大强化了安全编程。Rust 的*程序效率*与 C 相近，但其现代性、抽象表达能力高于 C 语言，故 Rust 的*程序开发效率*高于 C。这可以体现在以下几个方面：
    - 内存管理。C 语言使用手动内存管理，需要开发者负责申请和释放内存，这给编程带来了很多复杂性和风险，比如内存泄漏、野指针、缓冲区溢出等。Rust 语言使用所有权系统和借用检查机制，在编译期就能保证内存安全和线程安全，无需垃圾回收或运行时开销，让开发者更专注于程序本身。
    - 类型系统。C 语言使用弱类型系统，类型转换和运算比较灵活，但也容易引发错误和未定义行为。Rust 语言使用强类型系统，类型转换和运算需要显式注明，但也能提供更多的安全保障和抽象能力。Rust 语言还支持泛型、特征、枚举等高级类型特性，让代码更具表达力和复用性。
    - 编程范式。C 语言是一种过程式编程语言，主要使用函数和结构体来组织代码，没有面向对象或函数式编程的支持。Rust 语言是一种多范式编程语言，既可以使用函数和结构体来进行过程式编程，也可以使用方法、特征实现和闭包来进行面向对象或函数式编程。
    - 标准库。C 语言的标准库非常简单，只提供了一些基本的数据结构、算法、输入输出、数学运算等功能，很多高级或常用的功能需要依赖第三方库或自己实现。Rust 语言的标准库非常丰富，除了提供基本的数据结构、算法、输入输出、数学运算等功能外，还提供了并发、网络、文件系统、错误处理、测试、宏等高级功能。
  - Rust 操作系统已经有一些知名的项目，如 Redox OS、rCore OS 和 Tock OS，它们分别展示了 Rust 语言在通用操作系统、教学操作系统和嵌入式操作系统方面的应用。Rust 操作系统又以下几个优势：
    - 可以避免内存和并发错误。因为 Rust 语言有严格的所有权和生命周期检查，以及零成本的抽象。
    - 可以在不同的硬件平台上运行。因为 Rust 语言有良好的跨平台支持和底层控制能力，并支持包括 x86、ARM、MIPS 和 RISC-V 等各种指令集。
    - 可以运行许多现有程序。因为 Rust 语言拥有健全的生态与丰富的标准库，其能够兼容 POSIX 标准，并对 C 语言无缝集成。
    - 可以实现高性能和低资源占用。因为 Rust 语言有编译期优化和无运行时开销，以及对并发和异步编程的原生支持。
- **[ArceOS](https://github.com/rcore-os/arceos)：用 Rust 编写的实验性模块化操作系统**
  - ArceOS是 [rCore-OS](https://rcore-os.cn/) 开源操作系统社区的子项目之一，其灵感很大程度上来自 Unikraft。
  - 正在迅速地开发，在 [GitHub](https://github.com/rcore-os/arceos) 仓库中能找到实时信息。
- **[seL4](https://sel4.systems/)：目前唯一通过形式化证明的实时内核（候选项目）**
  - seL4 是一个开源的微内核操作系统，它是世界上第一个经过形式化验证的操作系统内核。这意味着它的实现已经被证明是正确的，且符合其规范。这为 seL4 提供了极高的安全性和可靠性。
  - seL4 还具有出色的实时性能，它是目前唯一具有完整实时性分析的保护模式操作系统内核。这意味着它具有可证明的中断延迟上限（以及任何其他内核操作的延迟）。
  - seL4 提供了操作系统所必需的服务，如线程、IPC、虚拟内存、中断等。它还支持虚拟机，可以运行完整的客户端操作系统，如 Linux。
  - 详情可见 seL4 [白皮书](https://sel4.systems/About/seL4-whitepaper.pdf) 和 [中文翻译](https://blog.csdn.net/lgfx21/article/details/117606097)。

## 相关工作

- **组件化定制操作系统的历史回顾**
  - 早在二十世纪九十年代，学术界就已经尝试过组件化定制操作系统的想法，如MIT的PDOS课题组提出的[Exokernel](https://pdos.csail.mit.edu/archive/exo/)和剑桥大学等提出的[Nemesis](https://www.cl.cam.ac.uk/research/srg/netos/projects/archive/nemesis/)操作系统是第一轮组件化操作系统的探索。
    - 其特点是通过把操作系统的部分功能以专用库的形式提供给应用程序使用，运行在用户态，以提升系统的整体性能。由于开发的成本过高，而使用领域比较窄，没有在产业界落地。
  - 进入二十一世纪，随着互联网的发展，如何优化云计算和虚拟化成为了新热点，学术界开始了第二轮组件化操作系统的发展。
    - 在2002年，犹它大学计算机科学系FLUX研究组提出了[OSKit](https://www.cs.utah.edu/flux/oskit/)项目，基于C语言设计了34个组件库和一个连接这些组件库的框架来形成不同功能的特定操作系统内核，其目标在于降低操作系统的研发门槛和成本。
    - [MirageOS](https://mirage.io/)是一个基于OCaml语言编写的库操作系统，它构建了安全的，高性能和资源节约型unikernel。代码可以在普通操作系统上开发，然后编译成在Xen或KVM虚拟机管理程序下运行的完全独立的专用单内核。
    - 这一次的探索依然没有被产业界广泛接受。这与编程语言的选择有很大的关系。C语言没有方便的面向对象的能力，也缺失泛型等语言特征，不具有广泛的重用性，难以形成可被广泛重用的组件。而OCaml语言的抽象能力很强，安全性也很好，但它具有主流函数式语言的通病，相对于C语言，其通用性很弱，而性能更差，缺少对已有应用的支持。
  - 2018年，Rice大学提出了基于Rust语言的[Theseus](https://github.com/theseus-os/Theseus)操作系统，通过精心设计的内核组件，支持操作系统的组件在线更新，使得操作系统的可靠性得到很大增强。但由于过于注重高可靠设计，在性能和已有应用的支持比较差。
  - 2014年以后，学术界意识到如果要得到产业界的认可，需要支持在性能和应用支持上突破，这方面的代表是多家单位合作设计的[Unikraft](https://github.com/unikraft/unikraft)操作系统。
    - Unikraft是一个快速，安全和开源的unikernel开发工具包，采用C语言编写，由不同的组件库构成，支持云计算环境中的常用Linux应用。由于其unikernel架构设计，Unikraft可以根据应用程序的特定需求定制操作系统、库和配置，大幅减少存储空间和其他软件的恶意攻击，同时让应用程序和OS内核都运行在特权态，提高了整体性能。Unikraft的性能和对Linux应用的支持，使得它得到了产业界一定的认可和使用。但Unikraft采用C语言设计实现，这导致了内核组件的重用性和安全性还需提高。
  - 这些组件化操作系统的尝试告诉我们几点：
    - 组件化操作系统致力于增强重用性和可靠性，但决不能忽视性能问题。
    - 使用合适的编程语言十分重要。
- **使用 Rust 开发操作系统的尝试**
  - [Redox](https://en.wikipedia.org/wiki/Redox_(operating_system))
    - Redox 内核基于微内核的概念，受到 MINIX 的启发
    - Ralloc – 内存分配器
    - TFS 文件系统 – 受到 [ZFS 文件系统](https://en.wikipedia.org/wiki/ZFS)的启发
    - Ion shell – Redox 中用于执行命令和脚本的基础库，也是默认的 shell
    - Redox OS 支持命令行界面 (CLI) 程序，也支持图形用户界面 (GUI) 程序
    - 参考资料：[Redox OS book](https://doc.redox-os.org/book/)
  - [rCore](https://rcore-os.github.io/)
    - 基于 RISC-V 架构，具有简单、模块化、可扩展的特点。
    - 支持多核和用户态进程，实现了基本的并发和抽象机制，如线程、进程、调度、同步、通信等。
    - 支持虚拟内存和文件系统，实现了基本的内存管理和存储管理机制，如分页、映射、缺页异常、文件操作等。
    - 支持系统调用和动态链接库，实现了基本的用户态程序运行环境，如输入输出、异常处理、动态加载等。
    - 支持网络通信和图形界面，实现了基本的网络协议栈和图形设备驱动，如 TCP/IP、Ethernet、Framebuffer 等。
    - 参考资料：[rCore-Tutorial-Book 第三版](http://rcore-os.cn/rCore-Tutorial-Book-v3/)，[rCore OS 开发文档（长久未更新）](https://rcore.gitbook.io/rust-os-docs/)，[BlogOS](https://os.phil-opp.com/)（rCore 基于 BlogOS）
  - [Tock](https://www.tockos.org/)
    - Tock OS 是一种为低功耗，低内存微控制器设计的嵌入式操作系统，它可以支持多个并发的，互不信任的应用程序。
    - Tock OS 允许第三方开发者使用驱动程序和内核扩展来增加系统的功能，而不需要修改内核代码。
    - Tock OS 使用协作式调度模型来管理内核中的组件，称为胶囊（capsules），以及用户空间中的进程（processes）。这样可以避免抢占式调度带来的资源消耗和上下文切换开销，同时保证系统的响应性和实时性。
    - Tock OS 支持自动的低功耗操作，根据系统的负载和外部事件来调整微控制器的工作模式和电源管理。
    - Tock OS 的设计使其能够在消费级物联网设备（如运动手表或健身追踪器）上运行，这些设备需要在小型电池上运行数月，并且具有低内存微控制器，以支持第三方应用程序，就像 PC 级操作系统一样。
  - [OSH-2019/x-qwq](https://github.com/OSH-2019/x-qwq/)
    - 已有学长用 Rust 改写 seL4 微内核，并成功编译出了一个操作系统。我们将有关 seL4 的工作作为候选项目。
